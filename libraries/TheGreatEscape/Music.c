#include "TheGreatEscape/Music.h"

/**
 * $F546
 */
const uint8_t music_channel0_data[] =
{
  0x13, 0x00, 0x14, 0x00, 0x00, 0x15, 0x16, 0x00,
  0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x16, 0x00, 0x1F, 0x00, 0x00, 0x1D, 0x1B, 0x00,
  0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1D, 0x00,
  0x00, 0x00, 0x1D, 0x00, 0x00, 0x1B, 0x1A, 0x00,
  0x1B, 0x00, 0x1A, 0x00, 0x18, 0x00, 0x16, 0x00,
  0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x13, 0x00, 0x14, 0x00, 0x00, 0x15, 0x16, 0x00,
  0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x16, 0x00, 0x1F, 0x00, 0x00, 0x1D, 0x1B, 0x00,
  0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1D, 0x00,
  0x00, 0x00, 0x1D, 0x00, 0x00, 0x1B, 0x1A, 0x00,
  0x16, 0x00, 0x00, 0x00, 0x1D, 0x00, 0x1B, 0x00,
  0x00, 0x00, 0x1F, 0x00, 0x00, 0x1D, 0x1B, 0x00,
  0x19, 0x00, 0x18, 0x00, 0x16, 0x00, 0x1B, 0x00,
  0x00, 0x00, 0x1B, 0x00, 0x1D, 0x00, 0x1B, 0x00,
  0x19, 0x00, 0x18, 0x00, 0x19, 0x00, 0x1B, 0x00,
  0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x24, 0x00,
  0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x20, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1D, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1B, 0x00,
  0x00, 0x00, 0x1B, 0x00, 0x00, 0x1D, 0x1B, 0x00,
  0x19, 0x00, 0x18, 0x00, 0x16, 0x00, 0x1B, 0x00,
  0x00, 0x00, 0x1B, 0x00, 0x1D, 0x00, 0x1B, 0x00,
  0x19, 0x00, 0x18, 0x00, 0x19, 0x00, 0x1B, 0x00,
  0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x20, 0x00,
  0x1F, 0x00, 0x20, 0x00, 0x21, 0x00, 0x22, 0x00,
  0x00, 0x00, 0x1D, 0x00, 0x00, 0x00, 0x1F, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x22, 0x00,
  0x00, 0x00, 0x22, 0x00, 0x00, 0x20, 0x1F, 0x00,
  0x1B, 0x00, 0x1D, 0x00, 0x1F, 0x00, 0x20, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x22, 0x00, 0x24, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x1F, 0x00,
  0x20, 0x00, 0x22, 0x00, 0x1B, 0x1D, 0x1F, 0x00,
  0x20, 0x00, 0x22, 0x00, 0x24, 0x00, 0x25, 0x00,
  0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x24, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x22, 0x00,
  0x00, 0x00, 0x1B, 0x00, 0x00, 0x1D, 0x1B, 0x00,
  0x19, 0x00, 0x18, 0x00, 0x19, 0x00, 0x1B, 0x00,
  0x00, 0x00, 0x1B, 0x00, 0x1D, 0x00, 0x1B, 0x00,
  0x19, 0x00, 0x18, 0x00, 0x19, 0x00, 0x1B, 0x00,
  0x00, 0x00, 0x27, 0x00, 0x00, 0x00, 0x27, 0x00,
  0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x24, 0x00,
  0x1B, 0x1B, 0x1A, 0x00, 0x1B, 0x00, 0x22, 0x00,
  0x1B, 0x1B, 0x1A, 0x00, 0x1B, 0x00, 0x20, 0x00,
  0x1B, 0x00, 0x18, 0x00, 0x1B, 0x00, 0x14, 0x00,
  0x1D, 0x00, 0x1E, 0x00, 0x1F, 0x00, 0x20, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x20, 0x00, 0x22, 0x00, 0x24, 0x00, 0x25, 0x00,
  0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x29, 0x00, 0x27, 0x00, 0x25, 0x00,
  0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x20, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x00, 0x22, 0x20, 0x00,
  0x1E, 0x00, 0x1D, 0x00, 0x1E, 0x00, 0x20, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x20, 0x00,
  0x20, 0x00, 0x22, 0x00, 0x24, 0x00, 0x25, 0x00,
  0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x24, 0x00, 0x25, 0x00, 0x26, 0x00, 0x27, 0x00,
  0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x24, 0x00,
  0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x27, 0x00,
  0x00, 0x00, 0x27, 0x00, 0x00, 0x29, 0x27, 0x00,
  0x25, 0x00, 0x24, 0x00, 0x22, 0x00, 0x20, 0x00,
  0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x20, 0x00,
  0x20, 0x00, 0x22, 0x00, 0x24, 0x00, 0x25, 0x00,
  0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x25, 0x00, 0x27, 0x00, 0x29, 0x00, 0x2A, 0x00,
  0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x25, 0x00,
  0x00, 0x00, 0x2A, 0x00, 0x00, 0x00, 0x29, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x25, 0x00, 0x27, 0x00, 0x29, 0x00,
  0x00, 0x00, 0x29, 0x00, 0x00, 0x00, 0x29, 0x00,
  0x25, 0x00, 0x27, 0x00, 0x25, 0x00, 0x22, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00,
  0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x29, 0x00,
  0x00, 0x00, 0x25, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x27, 0x00, 0x00, 0x00, 0x25, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0xFF
};

/**
 * $F7C7
 */
const uint8_t music_channel1_data[] =
{
  0x0A, 0x00, 0x0C, 0x00, 0x00, 0x0E, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x14, 0x00, 0x15, 0x00, 0x16, 0x00,
  0x1A, 0x00, 0x11, 0x00, 0x1A, 0x00, 0x16, 0x00,
  0x1A, 0x00, 0x11, 0x00, 0x1A, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x0A, 0x00, 0x0C, 0x00, 0x00, 0x0E, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x14, 0x00, 0x15, 0x00, 0x16, 0x00,
  0x1A, 0x00, 0x11, 0x00, 0x1A, 0x00, 0x16, 0x00,
  0x1A, 0x00, 0x11, 0x00, 0x1A, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x14, 0x00, 0x16, 0x00, 0x18, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x0F, 0x00, 0x11, 0x00, 0x13, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x0F, 0x00, 0x14, 0x00, 0x15, 0x00, 0x16, 0x00,
  0x1A, 0x00, 0x11, 0x00, 0x1A, 0x00, 0x16, 0x00,
  0x1A, 0x00, 0x11, 0x00, 0x1A, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x14, 0x00, 0x13, 0x00,
  0x16, 0x00, 0x0F, 0x00, 0x13, 0x00, 0x0A, 0x00,
  0x13, 0x00, 0x16, 0x00, 0x18, 0x00, 0x19, 0x00,
  0x14, 0x00, 0x11, 0x00, 0x19, 0x00, 0x18, 0x00,
  0x14, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x13, 0x00,
  0x16, 0x00, 0x0F, 0x00, 0x13, 0x00, 0x0A, 0x00,
  0x13, 0x00, 0x0F, 0x00, 0x13, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x13, 0x00,
  0x16, 0x00, 0x0F, 0x00, 0x16, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x0F, 0x00, 0x11, 0x00, 0x12, 0x00,
  0x16, 0x00, 0x0D, 0x00, 0x16, 0x00, 0x12, 0x00,
  0x16, 0x00, 0x0D, 0x00, 0x16, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x08, 0x00, 0x0A, 0x00, 0x0C, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x0D, 0x00, 0x0E, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x0F, 0x00,
  0x13, 0x00, 0x0A, 0x00, 0x13, 0x00, 0x14, 0x00,
  0x18, 0x00, 0x0F, 0x00, 0x18, 0x00, 0x14, 0x00,
  0x08, 0x00, 0x0A, 0x00, 0x0C, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x0A, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x0D, 0x00, 0x0F, 0x00, 0x11, 0x00, 0x12, 0x00,
  0x16, 0x00, 0x0D, 0x00, 0x16, 0x00, 0x12, 0x00,
  0x16, 0x00, 0x12, 0x00, 0x12, 0x00, 0x11, 0x00,
  0x15, 0x00, 0x0C, 0x00, 0x15, 0x00, 0x11, 0x00,
  0x15, 0x00, 0x11, 0x00, 0x0C, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x12, 0x00,
  0x16, 0x00, 0x0D, 0x00, 0x16, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0F, 0x00,
  0x08, 0x00, 0x0A, 0x00, 0x0C, 0x00, 0x0D, 0x00,
  0x11, 0x00, 0x08, 0x00, 0x11, 0x00, 0x0D, 0x00,
  0xFF
};

/**
 * $FA48: Music tuning table.
 */
static const uint16_t music_tuning_table[76] =
{
  0xFEFE,
  0x0000,
  0x0000,
  0x0000,
  0x0000,
  0x0218,
  0x01FA,
  0x01DE,
  0x01C3,
  0x01A9,
  0x0192,
  0x017B,
  0x0166,
  0x0152,
  0x013F,
  0x012D,
  0x011C,
  0x010C,
  0x00FD,
  0x00EF,
  0x00E1,
  0x00D5,
  0x00C9,
  0x00BE,
  0x00B3,
  0x00A9,
  0x009F,
  0x0096,
  0x008E,
  0x0086,
  0x007E,
  0x0077,
  0x0071,
  0x006A,
  0x0064,
  0x005F,
  0x0059,
  0x0054,
  0x0050,
  0x004B,
  0x0047,
  0x0043,
  0x003F,
  0x003C,
  0x0038,
  0x0035,
  0x0032,
  0x002F,
  0x002D,
  0x002A,
  0x0028,
  0x0026,
  0x0023,
  0x0021,
  0x0020,
  0x001E,
  0x001C,
  0x001B,
  0x0019,
  0x0018,
  0x0016,
  0x0015,
  0x0014,
  0x0013,
  0x0012,
  0x0011,
  0x0000,
  0x0000,
  0x0000,
  0x0000,
  0x0000,
  0x0000,
  0x0000,
  0x0000,
  0x0000,
  0x0000, // likely end of table
};

/* ----------------------------------------------------------------------- */

/**
 * $F52C: Get tuning.
 *
 * \param[in] A Index (never larger than 42?).
 * \param[in] L Speaker bit, to be reset.
 *
 * \returns (was DE)
 */
uint16_t get_tuning(uint8_t A, uint8_t *L)
{
  uint16_t BC;

  BC = music_tuning_table[A]; // FIXME: Original loads endian swapped...

#define INC_LO(x) \
do { x = (x & 0xFF00) | (((x & 0x00FF) + 0x0001) & 0x00FF); } while (0)
#define INC_HI(x) \
do { x = (x & 0x00FF) | (((x & 0xFF00) + 0x0100) & 0xFF00); } while (0)

  INC_LO(BC);
  INC_HI(BC);
  if ((BC & 0xFF00) == 0)
    INC_LO(BC);

  /* Reset the speaker bit. */
  *L = 0;

#undef INC_HI
#undef INC_LO

  return BC;
}

/* ----------------------------------------------------------------------- */

// vim: ts=8 sts=2 sw=2 et

